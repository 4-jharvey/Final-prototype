import javax.swing.*;
import java.sql.*;
import java.awt.*;
import java.util.ArrayList;
import java.util.List;
import java.util.HashMap;
import java.util.Map;
/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */

/**
 *
 * @author jwhar
 */
public class Leaderboard extends javax.swing.JFrame {
    
    private static final java.util.logging.Logger logger = java.util.logging.Logger.getLogger(Leaderboard.class.getName());


    private int tournamentID;
    public Leaderboard(int tournamentID) {
        this.tournamentID = tournamentID;
        initComponents();
        //JFrame fills the screen
        setExtendedState(JFrame.MAXIMIZED_BOTH);
        
        //Adds button to its own JPanel
        JPanel button = new JPanel(new GridLayout(1, 1));
        button.add(BackToBracket);
        
        //adds the button JPanel to the JFrame
        getContentPane().add(button, BorderLayout.SOUTH);
    }
    

    
    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        BackToBracket = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        getContentPane().setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        BackToBracket.setText("Back to Bracket");
        BackToBracket.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                BackToBracketActionPerformed(evt);
            }
        });
        getContentPane().add(BackToBracket, new org.netbeans.lib.awtextra.AbsoluteConstraints(650, 530, 190, 50));

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void BackToBracketActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_BackToBracketActionPerformed
        //takes user back to tournament screen
        Tournament Tourny = new Tournament(tournamentID);
        this.dispose();
        Tourny.setVisible(true);
    }//GEN-LAST:event_BackToBracketActionPerformed
    
    // method that creates the Leaderboard
    private void createLeaderboard(){
        //Gets the Match data from the database
        try(Connection connect = DatabaseConnection.getConnection()){
            String sql = "SELECT MatchID, TeamA, TeamB, Winner, TeamA_Score, TeamB_Score "
                         + "FROM Duel "
                         + "WHERE TournamentID = ? ";
            PreparedStatement psScore = connect.prepareStatement(sql);
            psScore.setInt(1, tournamentID);
            ResultSet rsScore = psScore.executeQuery();
            
            //Creates Hashmaps to store data in
            Map<Integer, Integer> wins = new HashMap<>();
            Map<Integer, Integer> points = new HashMap<>();
            Map<Integer, String> teams = new HashMap<>();
            
            while(rsScore.next()){
                //sets the match data from sql into variables
                int teamA = rsScore.getInt("TeamA");
                int teamB = rsScore.getInt("TeamB");
                String winner = rsScore.getString("Winner");
                int scoreA = rsScore.getInt("TeamA_Score");
                int scoreB = rsScore.getInt("TeamB_Score");
                
                //Makes sure that the data is entered into the teams hashmap
                teams.putIfAbsent(teamA, teamNames(connect, teamA));
                teams.putIfAbsent(teamB, teamNames(connect, teamB));
                
                //Updates the number of wins depending on who won the match
                if(winner.equals(teams.get(teamA))){
                    wins.put(teamA, wins.getOrDefault(teamA, 0) + 1);
                } else if(winner.equals(teams.get(teamB))){
                    wins.put(teamB, wins.getOrDefault(teamB, 0) + 1);
                }    
                
                //adds the score of each game in case of a tie in wins
                points.put(teamB, points.getOrDefault(teamB, 0) + scoreB);
                points.put(teamA, points.getOrDefault(teamA, 0) + scoreA);
            }
            
            //Creates a List of teams
            List<Integer> teamIDs = new ArrayList<>(teams.keySet());
            teamIDs.sort((teamA, teamB) -> {
                //Will sort the data in descending order depending on number of wins
                int winDif = wins.getOrDefault(teamB, 0) - wins.getOrDefault(teamA, 0);
                if(winDif != 0){
                    return winDif;
                } else {
                    //If tie in wins, it will order by total score
                    return points.getOrDefault(teamB, 0) - points.getOrDefault(teamA, 0);
                }
            });
            
            //Create a JPanel to add Leaderboard boxes to
            JPanel BoardPanel = new JPanel();
            BoardPanel.setLayout(new BoxLayout(BoardPanel, BoxLayout.Y_AXIS));
            
            //starts at 1st place
            int rank = 1;
            //Goes through all teams
            for (int teamID : teamIDs){
                //team name to add to box
                String name = teams.get(teamID);
                
                //creates boxes to add data into
                JPanel box = new JPanel();
                box.setBorder(BorderFactory.createLineBorder(new Color(0, 0, 0)));
                box.setLayout(new BoxLayout(box, BoxLayout.Y_AXIS));
                box.setBackground(new Color(255, 255, 255));
                
                //Adding ranks to the boxes
                JLabel rankLine = new JLabel(rank + ". " + name);
                box.add(rankLine);
                
                //Adds the box to the Leaderboard JPanel + gap between boxes
                BoardPanel.add(box);
                BoardPanel.add(Box.createVerticalStrut(10));
                
                //increase rank
                rank++;
            }
            
            //Adds the JPanel to a Scroll Pane and the scroll pane to the JFrame
            JScrollPane scroll = new JScrollPane(BoardPanel);
            getContentPane().setLayout(new BorderLayout());
            getContentPane().add(scroll, BorderLayout.CENTER);
            
            revalidate();
            repaint();
            
            //error catching    
        }catch (SQLException ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(null, "SQL error " + ex.toString());
        }  catch (Exception ex){
            ex.printStackTrace();
            JOptionPane.showMessageDialog(null, "Unexpected error " + ex.toString());
        }
            
    }
    
    //gets the team names through team IDs
    private String teamNames(Connection connect, int teamID) throws SQLException{
        //Selects team names that equal the team ID
        try{
            String names = "SELECT TeamName FROM Team "
                           + "WHERE TeamID = ?";
            PreparedStatement psNames = connect.prepareStatement(names);
            psNames.setInt(1, teamID);
            ResultSet Names = psNames.executeQuery();
            
            //Makes the data gained into variables
            if(Names.next()){
                return Names.getString("TeamName");
            }
            //detects errors
        }catch (SQLException ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(null, "SQL error " + ex.toString());
        }
        //returns nothing if no name found
        return " ";
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton BackToBracket;
    // End of variables declaration//GEN-END:variables
}
